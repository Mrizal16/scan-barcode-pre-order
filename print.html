<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Cetak / Unduh QR Token</title>
  <link rel="stylesheet" href="./style.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <main class="container">
    <div class="header">
      <h1>üñ®Ô∏è Export QR Token ‚Üí PNG/JPG</h1>
      <p class="muted">Upload <code>tokens.json</code>, pilih format/ukuran, logo & teks branding otomatis disisipkan.</p>

      <div class="control-grid" style="margin-top:8px">
        <label class="lbl" for="file">File</label>
        <input type="file" id="file" class="input" accept=".json">

        <label class="lbl" for="fmt">Format</label>
        <select id="fmt" class="input">
          <option value="png" selected>PNG (tajam)</option>
          <option value="jpeg">JPG (kecil)</option>
        </select>

        <label class="lbl" for="size">Ukuran QR</label>
        <select id="size" class="input">
          <option value="512">512 px</option>
          <option value="640" selected>640 px</option>
          <option value="800">800 px</option>
          <option value="1024">1024 px</option>
        </select>

        <label class="lbl" for="logo">Logo (opsional, override)</label>
        <input type="file" id="logo" class="input" accept="image/*">

        <label class="lbl" for="brand">Teks branding</label>
        <input id="brand" class="input" placeholder="mis. GANESIPALA ‚Ä¢ Official" value="GANESIPALA ‚Ä¢ Official">

        <label class="lbl" for="brandSize">Tinggi footer</label>
        <select id="brandSize" class="input">
          <option value="80">Kecil</option>
          <option value="110" selected>Sedang</option>
          <option value="140">Besar</option>
        </select>

        <label class="lbl" for="template">Template cetak</label>
        <select id="template" class="input">
          <option value="auto" selected>Otomatis (grid responsif)</option>
          <option value="a4-3x8">A4 3√ó8 (mirip Avery 5160)</option>
          <option value="a4-2x5">A4 2√ó5 (label besar)</option>
        </select>
      </div>

      <div class="btn-row" style="margin-top:10px">
        <button id="zipBtn" class="btn" disabled>üì¶ Download semua (ZIP)</button>
        <button id="printBtn" class="btn" disabled>üñ®Ô∏è Cetak lembar</button>
      </div>
      <div id="progress" class="muted small" style="margin-top:8px"></div>
    </div>

    <div id="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-top:16px"></div>
  </main>

  <script>
    const fileInput = document.getElementById('file');
    const grid = document.getElementById('grid');
    const fmtSel = document.getElementById('fmt');
    const sizeSel = document.getElementById('size');
    const brandInput = document.getElementById('brand');
    const brandSizeSel = document.getElementById('brandSize');
    const logoInput = document.getElementById('logo');
    const templateSel = document.getElementById('template');
    const zipBtn = document.getElementById('zipBtn');
    const printBtn = document.getElementById('printBtn');
    const progress = document.getElementById('progress');

    let records = [];    // {id, token}
    let canvases = [];   // {id, canvas}
    let logoImg = null;  // HTMLImageElement bila ada

    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const loadImageFromFile = (file)=> new Promise((res,rej)=>{
      const img = new Image(); img.onload=()=>res(img); img.onerror=rej;
      img.src = URL.createObjectURL(file);
    });
    const loadImageFromURL = (url)=> new Promise((res,rej)=>{
      const img = new Image(); img.onload=()=>res(img); img.onerror=rej;
      img.src = url;
    });

    // === AUTO-LOAD LOGO DEFAULT ===
    const DEFAULT_LOGO_PATH = './logo-ganesipala.png';
    async function tryLoadDefaultLogo(){
      try{
        const resp = await fetch(DEFAULT_LOGO_PATH, { cache: 'no-store' });
        if (!resp.ok) return;
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        logoImg = await loadImageFromURL(url);

        // Tampilkan ke input (indikasi visual)
        try{
          const dt = new DataTransfer();
          dt.items.add(new File([blob], 'logo-ganesipala.png', { type: blob.type }));
          logoInput.files = dt.files;
        }catch{}

        if (records.length) await buildCanvases();
      }catch{
        // tidak ada logo default -> abaikan
      }
    }
    document.addEventListener('DOMContentLoaded', tryLoadDefaultLogo);
    // ==============================

    function cardTemplate(id, dataUrl){
      const wrap = document.createElement('div');
      wrap.className = 'card';
      wrap.style.textAlign = 'center';
      const img = document.createElement('img');
      img.src = dataUrl; img.alt = id; img.style.width = '100%'; img.style.borderRadius='10px';
      const p = document.createElement('p'); p.innerHTML = `<b>${id}</b>`;
      const row = document.createElement('div'); row.className='btn-row'; row.style.justifyContent='center';
      const a = document.createElement('a'); a.className='btn'; a.textContent='‚¨áÔ∏è Unduh';
      a.download = `${id}.${fmtSel.value==='jpeg'?'jpg':'png'}`;
      a.href = dataUrl;
      row.appendChild(a);
      wrap.appendChild(img); wrap.appendChild(p); wrap.appendChild(row);
      return wrap;
    }

    async function buildCanvases(){
      canvases = [];
      grid.innerHTML = "";
      progress.textContent = "";
      if (!records.length) return;

      const qrSize = parseInt(sizeSel.value,10) || 640;
      const footerH = parseInt(brandSizeSel.value,10) || 110;
      const fmt = fmtSel.value;
      const mime = fmt==='jpeg' ? 'image/jpeg' : 'image/png';

      let i = 0;
      for (const {id, token} of records) {
        i++;
        progress.textContent = `Membuat QR ${i}/${records.length}‚Ä¶`;

        // QR pada canvas sementara
        const qrCanvas = document.createElement('canvas');
        await QRCode.toCanvas(qrCanvas, JSON.stringify({t: token}), { width: qrSize, margin: 1 });

        // Canvas final (QR + footer)
        const W = qrSize, H = qrSize + footerH;
        const final = document.createElement('canvas'); final.width = W; final.height = H;
        const ctx = final.getContext('2d');

        // background putih
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,W,H);

        // QR
        ctx.drawImage(qrCanvas, 0, 0);

        // separator
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(Math.round(W*0.08), qrSize, Math.round(W*0.84), 1);

        // footer
        const padding = 12;
        const areaY = qrSize + Math.round((footerH-64)/2);
        let x = padding, y = areaY;

        if (logoImg){
          const targetH = Math.min(footerH-24, 64);
          const ratio = logoImg.width / logoImg.height;
          const logoW = Math.round(targetH * ratio);
          const logoH = targetH;
          ctx.fillStyle = '#fff';
          ctx.fillRect(x, y - Math.round((logoH-48)/2), logoW, logoH);
          ctx.drawImage(logoImg, x, y - Math.round((logoH-48)/2), logoW, logoH);
          x += logoW + 12;
        }

        ctx.fillStyle = '#111827';
        ctx.font = '700 20px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
        ctx.textBaseline = 'top';
        ctx.fillText(String(id), x, y-2);

        const brand = brandInput.value?.trim();
        if (brand){
          ctx.fillStyle = '#374151';
          ctx.font = '500 16px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
          ctx.fillText(brand, x, y+22);
        }

        canvases.push({ id, canvas: final });

        const dataUrl = final.toDataURL(mime, fmt==='jpeg'?0.92:1);
        grid.appendChild(cardTemplate(id, dataUrl));
        await sleep(0);
      }

      progress.textContent = `Selesai membuat ${records.length} label.`;
      zipBtn.disabled = records.length===0;
      printBtn.disabled = records.length===0;
    }

    // events
    fileInput.addEventListener('change', async (e)=>{
      grid.innerHTML = ""; canvases=[]; records=[];
      zipBtn.disabled = true; printBtn.disabled = true; progress.textContent = "";
      const file = e.target.files[0];
      if (!file) return;
      try{
        const arr = JSON.parse(await file.text());
        if (!Array.isArray(arr)) throw new Error('Format tidak sesuai. Harus array objek {id, token}.');
        records = arr.map(x=>({ id: x.id ?? '', token: x.token ?? '' })).filter(x=>x.id && x.token);
        if (!records.length) throw new Error('Tidak ada item valid di file.');
        await buildCanvases();
      }catch(err){
        const card = document.createElement('div');
        card.className='card'; card.innerHTML = `<div class="alert err">‚ùå ${err.message||'Gagal membaca file.'}</div>`;
        grid.appendChild(card);
      }
    });

    // override manual logo (opsional)
    logoInput.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      try{ logoImg = await loadImageFromFile(f); }catch{}
      if (records.length) await buildCanvases();
    });

    [fmtSel, sizeSel, brandInput, brandSizeSel].forEach(el=>{
      el.addEventListener('change', ()=> buildCanvases());
      el.addEventListener('keyup',  ()=> buildCanvases());
    });

    // ZIP semua
    zipBtn.addEventListener('click', async ()=>{
      if (!canvases.length) return;
      zipBtn.disabled = true;
      const zip = new JSZip();
      const fmt = fmtSel.value;
      const mime = fmt==='jpeg' ? 'image/jpeg' : 'image/png';
      const ext = fmt==='jpeg' ? 'jpg' : 'png';
      let i = 0;
      for (const {id, canvas} of canvases){
        i++;
        progress.textContent = `Mengemas ZIP ${i}/${canvases.length}‚Ä¶`;
        const dataUrl = canvas.toDataURL(mime, fmt==='jpeg'?0.92:1);
        const base64 = dataUrl.split(',')[1];
        zip.file(`${id}.${ext}`, base64, {base64:true});
        await sleep(0);
      }
      const blob = await zip.generateAsync({type:'blob'});
      saveAs(blob, `qr-tokens-${Date.now()}.zip`);
      progress.textContent = `ZIP siap diunduh.`;
      zipBtn.disabled = false;
    });

    // template cetak
    function applyTemplate(){
      const t = templateSel.value;
      if (t==='a4-3x8'){
        grid.style.gridTemplateColumns = 'repeat(3, 1fr)';
      } else if (t==='a4-2x5'){
        grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
      } else {
        grid.style.gridTemplateColumns = 'repeat(auto-fill,minmax(220px,1fr))';
      }
    }
    templateSel.addEventListener('change', applyTemplate);
    applyTemplate();

    printBtn.addEventListener('click', ()=> window.print());
  </script>

  <style>
    /* Template cetak */
    @media print {
      body{background:white}
      .container{max-width:none;margin:0;padding:0}
      .header,.btn-row,.control-grid,#progress{display:none!important}
      #grid{gap:8px;margin:8px}
      .card{page-break-inside:avoid;border:1px solid #ccc;background:white}
      .card img{width:100%}
      .card p{color:#111}
    }
  </style>
</body>
</html>
